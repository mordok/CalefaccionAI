# Automatizaciones principales del sistema CalefaccionIA

automation:
  # ActivaciÃ³n solar inteligente
  - id: activacion_solar_geniaair
    alias: "ğŸŒ ActivaciÃ³n Solar GeniaAir"
    trigger:
      - platform: numeric_state
        entity_id: sensor.potencia_disponible_calefaccion
        above: 2000
        for:
          minutes: 5
      - platform: state
        entity_id: binary_sensor.demanda_calefaccion_general
        to: "on"
    condition:
      - condition: state
        entity_id: input_select.modo_calefaccion_solar
        state: "Auto Solar Inteligente"
      - condition: time
        after: "08:00:00"
        before: "18:00:00"
      - condition: numeric_state
        entity_id: sensor.potencia_disponible_calefaccion
        above: 1500
      - condition: state
        entity_id: binary_sensor.geniaair_activa
        state: "off"
      - condition: template
        value_template: >
          {% set zonas = states('sensor.zonas_demandando_calor') | int %}
          {{ zonas >= 1 }}
    action:
      - service: switch.turn_on
        entity_id: switch.contactor_caldera
      - service: script.gestionar_termostatos_segun_solar
      - service: notify.telegram_bot_7730409640_4634486477
        data:
          title: "ğŸŒ GeniaAir Activada con EnergÃ­a Solar"
          message: >
            ğŸ’¡ Potencia disponible: {{ states('sensor.potencia_disponible_calefaccion') }}W
            ğŸ  Zonas demandando: {{ states('sensor.zonas_demandando_calor') }}
            âš¡ COP estimado: {{ states('sensor.geniaair_cop_real') }}
            ğŸŒ¡ï¸ Temp exterior: {{ state_attr('weather.forecast_casa', 'temperature') }}Â°C

  # Precalentamiento predictivo
  - id: precalentamiento_predictivo_manacor
    alias: "ğŸŒ… Precalentamiento Predictivo Manacor"
    trigger:
      - platform: time
        at: input_datetime.hora_precalentamiento_inicio
      - platform: state
        entity_id: binary_sensor.es_hora_pico_solar
        to: "on"
    condition:
      - condition: state
        entity_id: input_select.modo_calefaccion_solar
        state: "Auto Solar Inteligente"
      - condition: numeric_state
        entity_id: sensor.prediccion_solar_proximas_6h
        above: 3
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: sensor.indice_precalentamiento
            above: 30
          - condition: numeric_state
            entity_id: sensor.power_production_now
            above: 3000
    action:
      - service: script.precalentamiento_inercia_6_zonas
      - service: notify.telegram_bot_7730409640_4634486477
        data:
          title: "ğŸŒ… Precalentamiento Predictivo Activado"
          message: >
            â˜€ï¸ ProducciÃ³n ahora: {{ states('sensor.power_production_now') }}W
            ğŸ“Š Ãndice precalentamiento: {{ states('sensor.indice_precalentamiento') }}%
            ğŸ”® PredicciÃ³n 6h: {{ states('sensor.prediccion_solar_proximas_6h') }}kWh
            ğŸŒ¡ï¸ Temp mÃ­n prevista: {{ state_attr('weather.forecast_casa', 'temperature') }}Â°C
            Sobrecalentando zonas prioritarias para acumular inercia

  # AcumulaciÃ³n mÃ¡xima hora pico
  - id: acumulacion_maxima_hora_pico
    alias: "â˜€ï¸ AcumulaciÃ³n MÃ¡xima Hora Pico"
    trigger:
      - platform: state
        entity_id: binary_sensor.es_hora_pico_solar
        to: "on"
      - platform: numeric_state
        entity_id: sensor.exceso_solar_disponible
        above: 4500
    condition:
      - condition: state
        entity_id: input_select.modo_calefaccion_solar
        state: "Auto Solar Inteligente"
      - condition: numeric_state
        entity_id: sensor.exceso_solar_disponible
        above: 4000
      - condition: time
        after: "11:00:00"
        before: "16:00:00"
    action:
      - service: script.acumulacion_maxima_inercia_6_zonas
      - service: notify.telegram_bot_7730409640_4634486477
        data:
          title: "â˜€ï¸ HORA PICO - AcumulaciÃ³n MÃ¡xima"
          message: >
            âš¡ Exceso solar: {{ states('sensor.exceso_solar_disponible') }}W
            ğŸ”¥ Potencia tÃ©rmica: {{ states('sensor.geniaair_potencia_termica') }}W
            ğŸ“ˆ COP actual: {{ states('sensor.geniaair_cop_real') }}
            Sobrecalentando TODAS las zonas +{{ states('input_number.sobrecalentamiento_inercia_max') }}Â°C
            Objetivo: {{ states('input_number.horas_inercia_objetivo') }}h de inercia

  # Control reactivo consumo
  - id: control_reactivo_consumo_legrand
    alias: "âš¡ Control Reactivo Consumo LEGRAND"
    trigger:
      - platform: state
        entity_id: sensor.geniaair_consumo_actual
    condition:
      - condition: state
        entity_id: binary_sensor.geniaair_activa
        state: "on"
      - condition: state
        entity_id: input_select.modo_calefaccion_solar
        state: "Auto Solar Inteligente"
      - condition: template
        value_template: >
          {% set consumo = states('sensor.geniaair_consumo_actual') | float %}
          {% set disponible = states('sensor.potencia_disponible_calefaccion') | float %}
          {{ consumo > (disponible + 300) }}
    action:
      - service: script.reducir_demanda_termostatos_prioritario
      - service: notify.telegram_bot_7730409640_4634486477
        data:
          title: "âš ï¸ Ajustando Consumo"
          message: >
            GeniaAir consume: {{ states('sensor.geniaair_consumo_actual') }}W
            Disponible solar: {{ states('sensor.potencia_disponible_calefaccion') }}W
            Reduciendo termostatos menos prioritarios

  # Apagar sin energÃ­a solar suficiente
  - id: apagar_geniaair_sin_solar
    alias: "ğŸŒ™ Apagar GeniaAir Sin Solar Suficiente"
    trigger:
      - platform: numeric_state
        entity_id: sensor.potencia_disponible_calefaccion
        below: 1000
        for:
          minutes: 10
      - platform: time
        at: "18:00:00"
    condition:
      - condition: state
        entity_id: input_select.modo_calefaccion_solar
        state: "Auto Solar Inteligente"
      - condition: state
        entity_id: binary_sensor.geniaair_activa
        state: "on"
      - condition: template
        value_template: >
          {% set temps = [
            states('sensor.temperatura_sala_fiable') | float,
            states('sensor.temperatura_bano_fibaro') | float,
            states('sensor.temperatura_dormitorio_fiable') | float
          ] %}
          {{ temps | min > 18.5 }}
    action:
      - service: script.modo_nocturno_6_zonas
      - delay: "00:02:00"
      - service: switch.turn_off
        entity_id: switch.contactor_caldera
      - service: notify.telegram_bot_7730409640_4634486477
        data:
          title: "ğŸŒ™ GeniaAir en Modo Nocturno"
          message: >
            â˜€ï¸ EnergÃ­a solar insuficiente: {{ states('sensor.potencia_disponible_calefaccion') }}W
            ğŸ  Usando inercia tÃ©rmica acumulada
            ğŸŒ¡ï¸ Temperaturas: Sala {{ states('sensor.temperatura_sala_fiable') }}Â°C, 
            BaÃ±os {{ states('sensor.temperatura_bano_fibaro') }}Â°C, 
            Dormitorio {{ states('sensor.temperatura_dormitorio_fiable') }}Â°C

  # ProtecciÃ³n nocturna anti-frÃ­o
  - id: proteccion_nocturna_antifrio
    alias: "â„ï¸ ProtecciÃ³n Nocturna Anti-FrÃ­o"
    trigger:
      - platform: template
        value_template: >
          {% set temps = [
            states('sensor.temperatura_sala_fiable') | float,
            states('sensor.temperatura_bano_fibaro') | float,
            states('sensor.temperatura_dormitorio_fiable') | float
          ] %}
          {{ temps | min < 17 }}
        for:
          minutes: 30
    condition:
      - condition: time
        after: "21:00:00"
        before: "08:00:00"
      - condition: state
        entity_id: binary_sensor.geniaair_activa
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.permitir_calefaccion_noche
            state: "on"
          - condition: template
            value_template: >
              {% set temp_min = [
                states('sensor.temperatura_sala_fiable') | float,
                states('sensor.temperatura_bano_fibaro') | float,
                states('sensor.temperatura_dormitorio_fiable') | float
              ] | min %}
              {{ temp_min < 16 }}
    action:
      - service: switch.turn_on
        entity_id: switch.contactor_caldera
      - service: script.calentamiento_emergencia_zonas_criticas
      - delay: "00:20:00"
      - service: switch.turn_off
        entity_id: switch.contactor_caldera
      - service: notify.telegram_bot_7730409640_4634486477
        data:
          title: "â„ï¸ EMERGENCIA - Calentamiento Nocturno"
          message: >
            ğŸš¨ Temperatura crÃ­tica detectada
            â±ï¸ Calentamiento 20 min desde red
            ğŸ’° Coste estimado: {{ (2.5 * 0.153) | round(2) }}â‚¬

  # OptimizaciÃ³n curva climÃ¡tica
  - id: optimizacion_curva_climatica
    alias: "ğŸ“Š OptimizaciÃ³n Curva ClimÃ¡tica"
    trigger:
      - platform: time_pattern
        hours: "/6"
    condition:
      - condition: state
        entity_id: input_select.modo_calefaccion_solar
        state: "Auto Solar Inteligente"
    action:
      - service: script.ajustar_curva_climatica_optima

  # Informe diario
  - id: informe_diario_geniaair
    alias: "ğŸ“Š Informe Diario GeniaAir"
    trigger:
      - platform: time
        at: "21:30:00"
    action:
      - service: notify.telegram_bot_7730409640_4634486477
        data:
          title: "ğŸ“Š Resumen Diario - GeniaAir Manacor"
          message: >
            ğŸŒ **PRODUCCIÃ“N SOLAR**
            ProducciÃ³n hoy: {{ states('sensor.energy_production_today') }}kWh
            Exceso mÃ¡ximo: {{ state_attr('sensor.exceso_solar_disponible', 'max_value') | round(0) }}W
            
            âš¡ **CONSUMO CALEFACCIÃ“N**
            EnergÃ­a consumida: {{ states('sensor.geniaair_energia_consumida_hoy') }}kWh
            COP medio: {{ states('sensor.geniaair_cop_medio_7_dias') }}
            
            ğŸ’° **AHORRO**
            Ahorro estimado hoy: {{ states('sensor.ahorro_economico_hoy') }}â‚¬
            Eficiencia solar media: {{ states('sensor.eficiencia_solar_actual') }}%
            
            ğŸ  **ZONAS**
            Zonas activas mÃ¡ximo: {{ states('sensor.zonas_demandando_calor') }}
            Temp media sala: {{ states('sensor.temperatura_sala_fiable') }}Â°C
            
            ğŸŒ¡ï¸ **EXTERIOR**
            Temp mÃ­n/mÃ¡x: {{ state_attr('weather.forecast_casa', 'temperature') }}Â°C
            
            Estado sistema: {{ states('sensor.estado_sistema_optimo') }}
